<div class="certificate-form-container">
  <div class="form-header">
    <div class="header-content">
      <div class="header-icon">
        <mat-icon>certificate</mat-icon>
      </div>
      <div class="header-text">
        <h1>{{ isEdit ? 'Edit Certificate' : 'Create New Certificate' }}</h1>
        <p>{{ isEdit ? 'Update certificate information' : 'Issue a new training certificate' }}</p>
      </div>
    </div>
    <div class="header-actions">
      <button mat-button (click)="cancel()" class="cancel-btn">
        <mat-icon>close</mat-icon>
        Cancel
      </button>
    </div>
  </div>

  <div class="form-content">
    <form [formGroup]="certificateForm" (ngSubmit)="onSubmit()">

      <!-- Batch Selection Section -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon class="section-icon">group_work</mat-icon>
          <h2>Batch Information</h2>
        </div>
        <div class="section-content">
          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Select Training Batch</mat-label>
            <mat-select formControlName="batch_id" required>
              <mat-option *ngFor="let batch of batches" [value]="batch.id">
                <div class="batch-option">
                  <div class="batch-primary">{{ batch.batch_number }}</div>
                  <div class="batch-secondary">{{ batch.company_name }} - {{ batch.certificate_type }}</div>
                </div>
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>business</mat-icon>
            <mat-error *ngIf="certificateForm.get('batch_id')?.hasError('required')">
              Please select a training batch
            </mat-error>
            <mat-hint>Choose the batch this certificate belongs to</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <!-- Personal Information Section -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon class="section-icon">person</mat-icon>
          <h2>Personal Information</h2>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Full Name</mat-label>
              <input matInput formControlName="name" required placeholder="Enter full name">
              <mat-icon matSuffix>person</mat-icon>
              <mat-error *ngIf="certificateForm.get('name')?.hasError('required')">
                Full name is required
              </mat-error>
              <mat-error *ngIf="certificateForm.get('name')?.hasError('minlength')">
                Name must be at least 2 characters
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Nationality</mat-label>
              <input matInput formControlName="nationality" required placeholder="Enter nationality">
              <mat-icon matSuffix>flag</mat-icon>
              <mat-error *ngIf="certificateForm.get('nationality')?.hasError('required')">
                Nationality is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>EID/License Number</mat-label>
              <input matInput formControlName="eid_license" required placeholder="Enter EID or license number">
              <mat-icon matSuffix>badge</mat-icon>
              <mat-error *ngIf="certificateForm.get('eid_license')?.hasError('required')">
                EID/License number is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Employer</mat-label>
              <input matInput formControlName="employer" required placeholder="Enter employer name" readonly>
              <mat-icon matSuffix>business</mat-icon>
              <mat-error *ngIf="certificateForm.get('employer')?.hasError('required')">
                Employer is required
              </mat-error>
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Training Information Section -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon class="section-icon">school</mat-icon>
          <h2>Training Information</h2>
        </div>
        <div class="section-content">

          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Training Program Name</mat-label>
            <input matInput formControlName="training_name" required placeholder="Enter training program name">
            <mat-icon matSuffix>school</mat-icon>
            <mat-error *ngIf="certificateForm.get('training_name')?.hasError('required')">
              Training program name is required
            </mat-error>
          </mat-form-field>
        </div>
      </div>

      <!-- Date Information Section -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon class="section-icon">event</mat-icon>
          <h2>Important Dates</h2>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label>Training Date</mat-label>
              <input matInput [matDatepicker]="trainingPicker" formControlName="training_date" required>
              <mat-datepicker-toggle matIconSuffix [for]="trainingPicker"></mat-datepicker-toggle>
              <mat-datepicker #trainingPicker></mat-datepicker>
              <mat-error *ngIf="certificateForm.get('training_date')?.hasError('required')">
                Training date is required
              </mat-error>
              <mat-hint>Date when training was conducted</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Issue Date</mat-label>
              <input matInput [matDatepicker]="issuePicker" formControlName="issue_date" required>
              <mat-datepicker-toggle matIconSuffix [for]="issuePicker"></mat-datepicker-toggle>
              <mat-datepicker #issuePicker></mat-datepicker>
              <mat-error *ngIf="certificateForm.get('issue_date')?.hasError('required')">
                Issue date is required
              </mat-error>
              <mat-hint>Date when certificate was issued</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Expiry Date</mat-label>
              <input matInput [matDatepicker]="duePicker" formControlName="due_date" required>
              <mat-datepicker-toggle matIconSuffix [for]="duePicker"></mat-datepicker-toggle>
              <mat-datepicker #duePicker></mat-datepicker>
              <mat-error *ngIf="certificateForm.get('due_date')?.hasError('required')">
                Expiry date is required
              </mat-error>
              <mat-hint>Date when certificate expires</mat-hint>
            </mat-form-field>
          </div>
        </div>
      </div>

      <!-- Certificate Number Section -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon class="section-icon">confirmation_number</mat-icon>
          <h2>Certificate Number</h2>
        </div>
        <div class="section-content">
          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Certificate Number</mat-label>
            <input matInput formControlName="certificate_number" placeholder="Leave empty for auto-generation">
            <mat-icon matSuffix>tag</mat-icon>
            <mat-hint>Leave empty to auto-generate based on system settings</mat-hint>
          </mat-form-field>
        </div>
      </div>

      <!-- File Uploads Section -->
      <div class="form-section">
        <div class="section-header">
          <mat-icon class="section-icon">attach_file</mat-icon>
          <h2>Document Uploads</h2>
        </div>
        <div class="section-content">
          <!-- Person Photo (Mandatory) -->
          <div class="upload-section mandatory-section">
            <div class="upload-card mandatory-card">
              <div class="upload-card-header">
                <div class="upload-icon-wrapper mandatory-icon">
                  <mat-icon>person</mat-icon>
                </div>
                <div class="upload-title-section">
                  <h3>Person Photo <span class="required-badge">Required</span></h3>
                  <p>Upload a clear photo of the certificate holder</p>
                </div>
              </div>

              <div class="upload-zone" [class.has-file]="hasFile('photo')" [class.mandatory-zone]="true">
                <input type="file" id="photo-input" accept="image/jpeg,image/jpg,image/png"
                  (change)="onFileSelected($event, 'photo')" style="display: none;">

                <div *ngIf="!hasFile('photo')" class="upload-dropzone" (click)="selectFile('photo-input')">
                  <div class="upload-icon-large">
                    <mat-icon>cloud_upload</mat-icon>
                  </div>
                  <div class="upload-text">
                    <span class="upload-primary">Click to upload photo</span>
                    <span class="upload-secondary">or drag and drop</span>
                  </div>
                  <div class="upload-formats">JPEG, JPG, PNG â€¢ Max 5MB</div>
                </div>

                <div *ngIf="hasFile('photo')" class="file-preview-card">
                  <div class="preview-image-container">
                    <img *ngIf="filePreviewUrls['photo']" [src]="filePreviewUrls['photo']" alt="Photo preview"
                      class="preview-image">
                  </div>
                  <div class="file-details">
                    <div class="file-name">{{ getFileName('photo') }}</div>
                    <div class="file-size">{{ getFileSize('photo') }}</div>
                    <button mat-icon-button (click)="removeFile('photo')" class="remove-file-btn" type="button">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Optional Documents -->
          <div class="upload-section optional-section">
            <div class="optional-header">
              <h3>Optional Documents</h3>
              <p>Upload additional documents for record keeping (all optional)</p>
            </div>

            <div class="optional-uploads-grid">
              <!-- Emirates ID -->
              <div class="upload-card optional-card">
                <div class="upload-card-header">
                  <div class="upload-icon-wrapper optional-icon">
                    <mat-icon>credit_card</mat-icon>
                  </div>
                  <div class="upload-title-section">
                    <h4>Emirates ID</h4>
                    <p>Identity document</p>
                  </div>
                </div>

                <div class="upload-zone compact" [class.has-file]="hasFile('eid')">
                  <input type="file" id="eid-input" accept="image/jpeg,image/jpg,image/png,application/pdf"
                    (change)="onFileSelected($event, 'eid')" style="display: none;">

                  <div *ngIf="!hasFile('eid')" class="upload-dropzone compact" (click)="selectFile('eid-input')">
                    <mat-icon class="upload-icon-small">cloud_upload</mat-icon>
                    <span class="upload-text-small">Upload EID</span>
                  </div>

                  <div *ngIf="hasFile('eid')" class="file-preview-compact">
                    <div class="file-icon-container">
                      <img *ngIf="filePreviewUrls['eid']" [src]="filePreviewUrls['eid']" alt="EID preview"
                        class="preview-thumbnail">
                      <mat-icon *ngIf="!filePreviewUrls['eid']" class="file-type-icon">description</mat-icon>
                    </div>
                    <div class="file-info-compact">
                      <div class="file-name-compact">{{ getFileName('eid') }}</div>
                      <button mat-icon-button (click)="removeFile('eid')" class="remove-compact-btn" type="button">
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Driving License -->
              <div class="upload-card optional-card">
                <div class="upload-card-header">
                  <div class="upload-icon-wrapper optional-icon">
                    <mat-icon>drive_eta</mat-icon>
                  </div>
                  <div class="upload-title-section">
                    <h4>Driving License</h4>
                    <p>License document</p>
                  </div>
                </div>

                <div class="upload-zone compact" [class.has-file]="hasFile('license')">
                  <input type="file" id="license-input" accept="image/jpeg,image/jpg,image/png,application/pdf"
                    (change)="onFileSelected($event, 'license')" style="display: none;">

                  <div *ngIf="!hasFile('license')" class="upload-dropzone compact"
                    (click)="selectFile('license-input')">
                    <mat-icon class="upload-icon-small">cloud_upload</mat-icon>
                    <span class="upload-text-small">Upload License</span>
                  </div>

                  <div *ngIf="hasFile('license')" class="file-preview-compact">
                    <div class="file-icon-container">
                      <img *ngIf="filePreviewUrls['license']" [src]="filePreviewUrls['license']" alt="License preview"
                        class="preview-thumbnail">
                      <mat-icon *ngIf="!filePreviewUrls['license']" class="file-type-icon">description</mat-icon>
                    </div>
                    <div class="file-info-compact">
                      <div class="file-name-compact">{{ getFileName('license') }}</div>
                      <button mat-icon-button (click)="removeFile('license')" class="remove-compact-btn" type="button">
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Signed Certificate -->
              <div class="upload-card optional-card">
                <div class="upload-card-header">
                  <div class="upload-icon-wrapper optional-icon">
                    <mat-icon>fact_check</mat-icon>
                  </div>
                  <div class="upload-title-section">
                    <h4>Signed Certificate</h4>
                    <p>Completed document</p>
                  </div>
                </div>

                <div class="upload-zone compact" [class.has-file]="hasFile('signed')">
                  <input type="file" id="signed-input" accept="image/jpeg,image/jpg,image/png,application/pdf"
                    (change)="onFileSelected($event, 'signed')" style="display: none;">

                  <div *ngIf="!hasFile('signed')" class="upload-dropzone compact" (click)="selectFile('signed-input')">
                    <mat-icon class="upload-icon-small">cloud_upload</mat-icon>
                    <span class="upload-text-small">Upload Document</span>
                  </div>

                  <div *ngIf="hasFile('signed')" class="file-preview-compact">
                    <div class="file-icon-container">
                      <img *ngIf="filePreviewUrls['signed']" [src]="filePreviewUrls['signed']"
                        alt="Signed document preview" class="preview-thumbnail">
                      <mat-icon *ngIf="!filePreviewUrls['signed']" class="file-type-icon">description</mat-icon>
                    </div>
                    <div class="file-info-compact">
                      <div class="file-name-compact">{{ getFileName('signed') }}</div>
                      <button mat-icon-button (click)="removeFile('signed')" class="remove-compact-btn" type="button">
                        <mat-icon>close</mat-icon>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Upload Guidelines -->
          <div class="upload-guidelines">
            <div class="guidelines-card">
              <mat-icon class="guidelines-icon">info</mat-icon>
              <div class="guidelines-content">
                <h4>Upload Guidelines</h4>
                <ul>
                  <li><strong>Person Photo:</strong> Required for certificate generation</li>
                  <li><strong>File Formats:</strong> JPEG, JPG, PNG, PDF</li>
                  <li><strong>File Size:</strong> Maximum 5MB per file</li>
                  <li><strong>Quality:</strong> Ensure documents are clear and readable</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <div class="actions-left">
          <button mat-button type="button" (click)="cancel()" class="cancel-button" [disabled]="isLoading">
            <mat-icon>arrow_back</mat-icon>
            Back to List
          </button>
        </div>
        <div class="actions-right">
          <button mat-raised-button color="primary" type="submit" [disabled]="certificateForm.invalid || isLoading"
            class="submit-button">
            <mat-icon>{{ isEdit ? 'save' : 'add' }}</mat-icon>
            {{ isLoading ? (uploadingFiles ? 'Uploading files...' : 'Saving...') : (isEdit ? 'Update Certificate' :
            'Create Certificate') }}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>